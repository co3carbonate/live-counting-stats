<!doctype html>
<html>
<head>
<meta charset="utf-8">
<base target='_blank'>
<title>Message Retrieval Tool</title>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-85403543-1', 'auto');
  ga('send', 'pageview');
</script>
<style>
h1 {
	margin-bottom: 10px;
}
body {
	font-family: Arial;
	font-size: 18px;
	text-align: center;
}
input[type=button] {
	cursor: pointer;	
}
label {
	display: block;
	margin: 6px;
}
label:not(.selected) {
	opacity: 0.5;
	cursor: pointer;
}
label:not(.selected) > input[type=radio] {
	cursor: pointer;
}
a[href] {
	text-decoration: none;
}
a[href]:hover {
	text-decoration: underline;
}
table {
	margin: 0 auto;
}
th, td {
	padding: 8px;
	white-space: normal;
	word-wrap: break-word;
}
#table tr:hover {
	background-color: #E1F2FF;
}
th:first-child, td:first-child {
	text-align: right;
}
</style>
<script>
function errorLoadingData() {
	window.failedToLoad = true;
}
</script>
<script src='plugins/pace.min.js'></script>
<link href='plugins/pace.theme.css' rel='stylesheet'/>
<script src='data/data.js?v=2' onerror='errorLoadingData()'></script>
<script>
// Pace (loading bar) adjustment
Pace.options = {
	ajax: false
};

// Useful functions
function getNo(str) {
    var l = str.length;
    if(l == 0) return null;
        
    var r = '';
    for(var i = 0; i < l; i++) {
        var s = str.charAt(i);
        if(/^\d+$/.test(s)) {
            r += s;
            continue;
        }
        else if([' ', ',', '~', '^', '#', '*', '>'].indexOf(s) > -1) {
            continue;
        } else {
            break;    
        }
    }
    if(r == '' || !/\d/.test(r)) r = null;
    return r;
}

</script>
</head>

<body>

<div id='allBody' style='display: none;'>

<!-- Heading -->
Created by <a href='https://www.reddit.com/user/co3_carbonate/'>/u/co3_carbonate</a><br>
<h1>Message Retrieval Tool</h1>
(Last updated to <span id='lastUpdated'>...</span>)<br><br>

<!-- Options for Message Retrieval -->
<!-- Message with count -->
<label class='selected'>
	<input type='radio' name='retrieveRadio' checked>
	Retrieve message with count:
	<input type='number' placeholder='Enter number' id='countIn'/>
	<input type='button' value='+' id='countIncrease'>
	<input type='button' value='-' id='countDecrease'>
</label>

<!-- Message containing word -->
<label>
	<input type='radio' name='retrieveRadio'>
	Retrieve message containing word:
	<input type='text' placeholder='Enter word'/>
</label>

<!-- Message containing text -->
<label>
	<input type='radio' name='retrieveRadio'>
	Retrieve message containing text:
	<input type='text' placeholder='Enter text'/>
</label>

<!-- Retrieve button -->
<br><br><input type='button' value='Retrieve' id='retrieveBtn'>

<br><br>

<!-- Output Table -->
<table style='display: none;'>
<thead><tr>
	<th>#</th>
	<th>Time (<span id='timezone'>...</span>)</th>
	<th>Author</th>
	<th>Body</th>
	<th></th>
</tr></thead>
<tbody id='table'></tbody>
</table><br><br>

</div>

<script>

// If data.js failed to load, overwrite all content
function loadingFailedCheck() {
	if(failedToLoad) {
		Pace.stop();
		document.getElementById('allBody').style.display = '';
		document.getElementById('allBody').innerHTML = 'Server Error: Unable to load data. Please try again in 30 seconds.';
		throw 'Server Error: Unable to load data.';
	}
}
loadingFailedCheck();

</script>
<script>

Pace.on('hide', function(){

// Check if all data was able to load
loadingFailedCheck();

// Things to do once the document has loaded
// Dynamically set text of certain parts of the document
document.getElementById('allBody').style.display = '';
document.getElementById('lastUpdated').innerHTML = getNo(chat[0].body);

var now = new Date().toString();
var TZ = now.indexOf('(') > -1 ?
now.match(/\([^\)]+\)/)[0].match(/[A-Z]/g).join('') :
now.match(/[A-Z]{3,4}/)[0];
if (TZ == "GMT" && /(GMT\W*\d{4})/.test(now)) TZ = RegExp.$1;
document.getElementById('timezone').innerHTML = TZ;

// More global variables
var l = chat.length;
var filter = function(info, input) {
	return getNo(info.body) == input;
};
var selected = document.getElementsByClassName('selected')[0];
var selectedInput = selected.querySelector('input[type=text], input[type=number');
selectedInput.focus();
var radios = document.getElementsByName('retrieveRadio');
var inputs = document.querySelectorAll('label input[type=text], label input[type=number]');
var labels = document.querySelectorAll('label');
var firstLookup = true;

// --

// Function to retrieve a message and display it to the table
// The 'filter' global variable is used to determine which messages should be included in the table
function retrieve() {
	// validate
	var input = selectedInput.value;
	if(input.trim().length == 0) return;

	// lookup
	var results = [];
	for(var i = 0; i < l; i++) {
		var info = chat[i];
		if(firstLookup) info.prevName = (i > 0) ? chat[i - 1].name : chat[i].name;

		if(filter(info, input)) {
			results.push(info);
		}
	}
	results.reverse();
	firstLookup = false;

	// display results
	var x = results.length;
	document.getElementById('table').innerHTML = '';
	document.getElementById('table').parentNode.style.display = '';
	if(x == 0) document.getElementById('table').innerHTML = '<tr><td colspan="4">No message retrieved for this number</td></tr>';

	for(var i = 0; i < x; i++) {
		var info = results[i];
		var newRow = document.createElement('tr');
		var newCols = {
			'author': document.createElement('td'),
			'time' : document.createElement('td'),
			'body' : document.createElement('td'),
			'url' : document.createElement('td'),
			'operations': document.createElement('td')
		};

		newCols.author.innerHTML = (info.author) ? 
			'<a href="https://www.reddit.com/user/' + info.author + '">/u/' + info.author + '</a>'
		: '[deleted]';
		newCols.body.innerHTML = info.body;
		newCols.url.innerHTML = '<a href="https://www.reddit.com/live/ta535s1hq2je/updates/' + info.id + '">' + (i+1) + '</a>';
		newCols.operations.innerHTML = "<a href='https://www.reddit.com/live/ta535s1hq2je/?after=" + info.prevName + "'><input type='button' value='context'/></a>";

		var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
		var date = new Date(0);
    	date.setUTCSeconds(info.created_utc);
    	var hours = date.getHours();
    	var suffix = (hours >= 12) ? 'pm' : 'am';
		hours = ((hours + 11) % 12 + 1);
		newCols.time.innerHTML = date.getDate() + ' ' +  months[date.getMonth()] + " '" + date.getFullYear().toString().substring(2) + ' ' + hours +':'+ ('0' + (date.getMinutes())).slice(-2) + suffix;

		newRow.appendChild(newCols.url);
		newRow.appendChild(newCols.time);
		newRow.appendChild(newCols.author);
		newRow.appendChild(newCols.body);
		newRow.appendChild(newCols.operations);
		document.getElementById('table').appendChild(newRow);
	}

}

// --

// Trigger the retrieve function
document.getElementById('retrieveBtn').onclick = retrieve;
for(var i = 0, x = inputs.length; i < x; i++) {
	(function(i){
		inputs[i].onkeydown = function(e) {
			if(e.keyCode == 13) {
				retrieve();	
			}
		}
	})(i);
}

// Function to handle inputs' (in label) disability (switching between enabled and disabled)
function enableDisableInputs() {
	for(var i = 0, x = labels.length; i < x; i++) {
		var thisInputs = labels[i].querySelectorAll('input:not([type=radio])');
		var bool = !labels[i].classList.contains('selected');
		for(var j = 0, y = thisInputs.length; j < y; j++) {
			thisInputs[j].disabled = bool;
		}
	}
}
enableDisableInputs();

// Radio buttons clicked
for(var i = 0, x = radios.length; i < x; i++) {
	(function(i) {
		radios[i].onchange = function() {
			if(this.parentNode.classList.contains('selected')) return; // already selected
			selected.classList.remove('selected');
			selected = this.parentNode;
			selected.classList.add('selected');
			selectedInput = selected.querySelector('input[type=text], input[type=number]');
			enableDisableInputs();
			setTimeout(function() {
				selectedInput.focus(); 
			}, 0);
			switch(i) {
				case 0:
					// Message with count
					filter = function(info, input) {
						return getNo(info.body) == input;
					};
					break;
				case 1:
					// Message containing word
					filter = function(info, input) {
						return (' ' +info.body+ ' ').indexOf(' ' +input+ ' ') > -1;
					};
					break;
				case 2:
					// Message containing text
					filter = function(info, input) {
						return info.body.indexOf(input) > -1;
					};
					break;
			}
		}
	})(i);
}

// +/- key (only for count)
function addOrMinus(val) {
	if(this.id == 'countIncrease') val = 1;
	else if(this.id == 'countDecrease') val = -1;

	var num = +selectedInput.value;
	num += val;
	document.getElementById('countIn').value = Math.max(0, num);
	retrieve();
}
document.getElementById('countIncrease').onclick = addOrMinus;
document.getElementById('countDecrease').onclick = addOrMinus;





}); // THE END

</script>



</body>
</html>
